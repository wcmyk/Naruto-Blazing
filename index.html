<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blazing ‚Äî Manual Background Switch (Responsive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/background.css" />
  <link rel="stylesheet" href="css/top-bar.css" />
  <link rel="stylesheet" href="css/character-vignette.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/summon-banner-carousel.css" />
</head>

<body>
  <!-- Default background -->
  <div id="full-bg" class="bg-1"></div>

  <!-- Character Vignette Display -->
  <div class="character-vignette-container"></div>

  <!-- Vignette Edge Fading Effect -->
  <div class="vignette-overlay"></div>

  <!-- Wind Animation Particles -->
  <div class="wind-container"></div>

  <!-- Top Bar Overlay - Ninja Rank & Currency HUD -->
  <div class="top-bar">
    <div class="ninja-rank-progress-container">
      <div class="ninja-rank-info">
        <span class="ninja-rank-label">Ninja Rank:</span>
        <span class="ninja-rank-value" id="ninja-rank-value">1</span>
      </div>
      <div class="rank-progress-bar-wrapper">
        <div class="rank-progress-bar-fill" id="rank-progress-bar-fill" style="width: 0%;"></div>
        <div class="rank-progress-text" id="rank-progress-text">0%</div>
      </div>
    </div>

    <div class="collection-stats" id="collection-stats">
      <span class="collection-icon">üìö</span>
      <span class="collection-value" id="collection-value">0%</span>
      <span class="collection-label">Collection</span>
    </div>

    <div class="currency-hud">
      <div class="currency-item ninja-pearls">
        <img src="assets/icons/currency/ninjapearl.png" alt="Ninja Pearls" class="currency-icon"
             onerror="this.style.display='none';">
        <span class="currency-amount" id="currency-ninja-pearls">0</span>
      </div>
      <div class="currency-item shinobites">
        <img src="assets/icons/currency/shinobite.png" alt="Shinobites" class="currency-icon"
             onerror="this.style.display='none';">
        <span class="currency-amount" id="currency-shinobites">0</span>
      </div>
      <div class="currency-item ryo">
        <img src="assets/icons/currency/ryo.png" alt="Ryo" class="currency-icon"
             onerror="this.style.display='none';">
        <span class="currency-amount" id="currency-ryo">0</span>
      </div>
    </div>
  </div>

  <!-- Daily Login Indicator -->
  <div class="daily-login-indicator" id="daily-login-indicator">
    <div class="daily-login-icon">üéÅ</div>
    <div class="daily-login-text">
      <div class="daily-login-label">Daily Login</div>
      <div class="daily-login-day" id="daily-login-day">Day 1/7</div>
    </div>
  </div>

  <!-- Calendar and Mailbox Icons (next to Daily Login) -->
  <div class="dashboard-icons-container">
    <button class="icon-button" id="btn-calendar" aria-label="Calendar" title="Daily Streak Calendar">
      <img src="assets/icons/main/calendar.png" alt="Calendar" onerror="this.style.display='none'; this.parentElement.innerHTML='üìÖ';">
    </button>

    <button class="icon-button" id="btn-mailbox" aria-label="Mailbox" title="Mailbox">
      <img src="assets/icons/main/mailbox.png" alt="Mailbox" onerror="this.style.display='none'; this.parentElement.innerHTML='üì¨';">
      <div class="icon-badge" id="mailbox-badge" style="display: none;">0</div>
    </button>
  </div>

  <!-- Announcement Banner Container -->
  <div class="announcement-banner-container" id="announcement-banner-container"></div>

  <!-- Main Content Area -->
  <div class="dashboard-banner-section">
    <!-- Full-Width Banner Slideshow -->
    <div class="banner-slideshow" id="dashboard-banner-slideshow"></div>
  </div>

  <!-- HUD Bottom Bar -->
  <div class="bottom-bar">
    <div class="bottom-bar-content">
      <button class="hud-button active" id="btn-village" aria-label="Village">
        <img src="assets/icons/village_icon.png" alt="Village">
      </button>
      <button class="hud-button" id="btn-characters" aria-label="Characters">
        <img src="assets/icons/characters_icon.png" alt="Characters">
      </button>
      <button class="hud-button" id="btn-fusion" aria-label="Fusion">
        <img src="assets/icons/fusion_icon.png" alt="Fusion">
      </button>
      <button class="hud-button" id="btn-teams" aria-label="Teams">
        <img src="assets/icons/teams_icon.png" alt="Teams">
      </button>
      <button class="hud-button" id="btn-summon" aria-label="Summon">
        <img src="assets/icons/summon_icon.png" alt="Summon">
      </button>
      <button class="hud-button" id="btn-missions" aria-label="Missions">
        <img src="assets/icons/missions_icon.png" alt="Missions">
      </button>
      <button class="hud-button" id="btn-inventory" aria-label="Inventory">
        <img src="assets/icons/inventory_icon.png" alt="Inventory">
      </button>
      <button class="hud-button" id="btn-shop" aria-label="Shop">
        <img src="assets/icons/shop_icon.png" alt="Shop">
      </button>
      <!-- Index.html exclusive buttons -->
      <button class="hud-button" id="btn-addchar" aria-label="Add Character">
        <img src="assets/icons/add_icon.png" alt="Add Character">
      </button>
      <button class="hud-button" id="btn-settings" aria-label="Settings">
        <img src="assets/icons/settings_icon.png" alt="Settings">
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/navigation.js"></script>
  <script src="js/user-profile.js"></script>
  <script src="js/audio-manager.js"></script>
  <script src="js/character_inv.js"></script>
  <script src="js/resources.js"></script>
  <script src="js/daily-missions.js"></script>
  <script src="js/top-bar.js"></script>
  <script src="js/character-vignette.js"></script>
  <script src="js/dashboard-announcements.js"></script>
  <script src="js/dashboard-banner-slideshow.js"></script>
  <script src="js/dashboard-calendar.js"></script>
  <script src="js/dashboard-stats.js"></script>
  <script src="js/dashboard-mailbox.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("‚úÖ JavaScript loaded!");

      // Initialize Dashboard Systems
      console.log("üéÆ Initializing Dashboard Systems...");

      // Initialize Calendar and Daily Streak
      if (window.DashboardCalendar) {
        window.DashboardCalendar.init();
        await updateDailyLoginDisplay();
      }

      // Initialize Mailbox
      if (window.DashboardMailbox) {
        window.DashboardMailbox.init();
        updateMailboxBadge();
      }

      // Initialize Stats
      if (window.DashboardStats) {
        await window.DashboardStats.init();
        updateCollectionStats();
      }

      // Initialize Announcements
      if (window.DashboardAnnouncements) {
        await window.DashboardAnnouncements.init('announcement-banner-container');
      }

      // Initialize Banner Slideshow
      if (window.DashboardBannerSlideshow) {
        await window.DashboardBannerSlideshow.init('dashboard-banner-slideshow');
      }

      // Update Ninja Rank Progress Bar
      updateRankProgressBar();

      // Process login bonus
      if (typeof window.DailyMissions !== "undefined") {
        const loginResult = await window.DailyMissions.processLogin();
        if (loginResult.ok && !loginResult.alreadyClaimed) {
          const rewardText = Object.entries(loginResult.reward)
            .map(([mat, amt]) => `${mat}: ${amt}`)
            .join(", ");
          alert(`Login Bonus Day ${loginResult.loginDay}!\n\nRewards:\n${rewardText}`);
        }
      }

      // Helper Functions
      async function updateDailyLoginDisplay() {
        const streak = window.DashboardCalendar.getStreak();
        const dayElement = document.getElementById('daily-login-day');
        const indicator = document.getElementById('daily-login-indicator');

        if (dayElement) {
          dayElement.textContent = `Day ${streak}/7`;
        }

        // Add notification dot if login bonus is available
        if (window.DailyMissions) {
          const loginStatus = await window.DailyMissions.getLoginStatus();
          if (loginStatus && !loginStatus.claimedToday) {
            indicator.classList.add('has-reward');
          }
        }
      }

      function updateMailboxBadge() {
        const unreadCount = window.DashboardMailbox.getUnreadCount();
        const badge = document.getElementById('mailbox-badge');

        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      function updateCollectionStats() {
        const percentage = window.DashboardStats.getCollectionPercentage();
        const valueElement = document.getElementById('collection-value');

        if (valueElement) {
          valueElement.textContent = percentage.toFixed(1) + '%';
        }
      }

      function updateRankProgressBar() {
        // Get current rank data from localStorage or default
        const rankData = JSON.parse(localStorage.getItem('ninjaRank') || '{"level": 1, "xp": 0, "xpToNext": 100}');

        const percentage = Math.min(100, (rankData.xp / rankData.xpToNext) * 100);
        const fillElement = document.getElementById('rank-progress-bar-fill');
        const textElement = document.getElementById('rank-progress-text');

        if (fillElement) {
          fillElement.style.width = percentage + '%';
        }

        if (textElement) {
          textElement.textContent = Math.floor(percentage) + '%';
        }
      }

      // Calendar Button Event
      const btnCalendar = document.getElementById('btn-calendar');
      if (btnCalendar) {
        btnCalendar.addEventListener('click', () => {
          console.log('üìÖ Calendar clicked');
          if (window.DashboardCalendar) {
            window.DashboardCalendar.openCalendar();
          }
        });
      }

      // Mailbox Button Event
      const btnMailbox = document.getElementById('btn-mailbox');
      if (btnMailbox) {
        btnMailbox.addEventListener('click', () => {
          console.log('üì¨ Mailbox clicked');
          if (window.DashboardMailbox) {
            window.DashboardMailbox.openMailbox();
          }
        });
      }

      // Daily Login Indicator Click Event
      const dailyLoginIndicator = document.getElementById('daily-login-indicator');
      if (dailyLoginIndicator) {
        dailyLoginIndicator.addEventListener('click', async () => {
          console.log('üéÅ Daily Login clicked');

          if (typeof window.DailyMissions !== "undefined") {
            const loginResult = await window.DailyMissions.processLogin();

            if (loginResult.ok) {
              if (loginResult.alreadyClaimed) {
                alert(`You've already claimed today's login bonus!\n\nCurrent Login Day: ${loginResult.loginDay}/7\n\nCome back tomorrow for more rewards!`);
              } else {
                const rewardText = Object.entries(loginResult.reward)
                  .map(([mat, amt]) => `${mat}: ${amt}`)
                  .join("\n");
                alert(`üéÅ Login Bonus Day ${loginResult.loginDay}!\n\nRewards Claimed:\n${rewardText}`);

                // Remove notification dot after claiming
                dailyLoginIndicator.classList.remove('has-reward');
              }
            }
          }
        });
      }

      // Background cycling
      const el = document.getElementById("full-bg");
      const total = 10;
      let current = 1;

      function updateBG(n) {
        for (let i = 1; i <= total; i++) {
          el.classList.remove(`bg-${i}`);
        }
        el.classList.add(`bg-${n}`);
        console.log(`üé® Background changed to bg-${n}`);
      }

      // Helper function for navigation (used by Settings button)
      function navigateTo(url) {
        console.log(`üöÄ Navigating to: ${url}`);
        document.body.style.transition = "opacity 0.2s linear";
        document.body.style.opacity = "0";
        setTimeout(() => {
          window.location.href = url;
        }, 200);
      }

      // Add Character button (index.html specific)
      const btnAddChar = document.getElementById("btn-addchar");
      if (btnAddChar) {
        btnAddChar.addEventListener("click", () => {
          console.log("‚ûï Add Character clicked");
          const id = prompt("Enter Character ID from characters.json (e.g. 'naruto_01')");
          if (id && typeof window.addCharacterById === "function") {
            window.addCharacterById(id.trim());
            console.log(`‚úÖ Added character: ${id}`);
          } else if (id) {
            console.error("‚ö†Ô∏è addCharacterById not loaded yet");
            alert("The Add Character system isn't ready yet. Please reload the page.");
          }
        });
      }

      // Settings button (with background changer, username, audio, character display, and resources)
      const btnSettings = document.getElementById("btn-settings");
      if (btnSettings) {
        btnSettings.addEventListener("click", () => {
          console.log("‚öôÔ∏è Settings clicked");
          showSettingsMenu();
        });
      }

      // Settings menu handler
      function showSettingsMenu() {
        const choice = prompt(
          "‚öôÔ∏è SETTINGS MENU\n\n" +
          "1. Change Username\n" +
          "2. Change Background (1-10)\n" +
          "3. Audio Settings\n" +
          "4. Select Character Display\n" +
          "5. View Resources\n" +
          "6. Cancel\n\n" +
          "Enter your choice:"
        );

        if (choice === "1") {
          const currentUsername = window.UserProfile.getUsername();
          const newUsername = prompt(`Current username: ${currentUsername}\n\nEnter new username (max 20 characters):`);

          if (newUsername && newUsername.trim()) {
            const success = window.UserProfile.setUsername(newUsername);
            if (success) {
              alert(`‚úÖ Username changed to: ${newUsername.trim()}`);
            } else {
              alert("‚ùå Failed to change username. Please use 1-20 characters.");
            }
          }
        } else if (choice === "2") {
          const bgNum = prompt("Enter background number (1-10):");
          const num = parseInt(bgNum);
          if (num >= 1 && num <= 10) {
            current = num;
            updateBG(current);
          } else {
            alert("Invalid background number. Please enter 1-10.");
          }
        } else if (choice === "3") {
          showAudioSettings();
        } else if (choice === "4") {
          if (typeof window.CharacterVignette !== "undefined") {
            window.CharacterVignette.openCharacterSelector();
          } else {
            alert("Character Vignette system not loaded yet. Please reload the page.");
          }
        } else if (choice === "5") {
          navigateTo("resources.html");
        }
      }

      // Audio settings submenu
      function showAudioSettings() {
        const masterVol = window.AudioManager.getVolumePercent("master");
        const bgmVol = window.AudioManager.getVolumePercent("bgm");
        const sfxVol = window.AudioManager.getVolumePercent("sfx");
        const settings = window.AudioManager.getSettings();

        const choice = prompt(
          "üîä AUDIO SETTINGS\n\n" +
          `Master Volume: ${masterVol}% ${settings.masterMuted ? "(MUTED)" : ""}\n` +
          `BGM Volume: ${bgmVol}% ${settings.bgmMuted ? "(MUTED)" : ""}\n` +
          `SFX Volume: ${sfxVol}% ${settings.sfxMuted ? "(MUTED)" : ""}\n\n` +
          "1. Set Master Volume (0-100)\n" +
          "2. Set BGM Volume (0-100)\n" +
          "3. Set SFX Volume (0-100)\n" +
          "4. Toggle Master Mute\n" +
          "5. Toggle BGM Mute\n" +
          "6. Toggle SFX Mute\n" +
          "7. Reset to Defaults\n" +
          "8. Back to Settings\n\n" +
          "Enter your choice:"
        );

        if (choice === "1") {
          const vol = prompt("Enter Master Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setMasterVolume(num / 100);
            alert(`‚úÖ Master volume set to ${num}%`);
          } else {
            alert("‚ùå Invalid volume. Please enter 0-100.");
          }
          showAudioSettings();
        } else if (choice === "2") {
          const vol = prompt("Enter BGM Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setBGMVolume(num / 100);
            alert(`‚úÖ BGM volume set to ${num}%`);
          } else {
            alert("‚ùå Invalid volume. Please enter 0-100.");
          }
          showAudioSettings();
        } else if (choice === "3") {
          const vol = prompt("Enter SFX Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setSFXVolume(num / 100);
            alert(`‚úÖ SFX volume set to ${num}%`);
          } else {
            alert("‚ùå Invalid volume. Please enter 0-100.");
          }
          showAudioSettings();
        } else if (choice === "4") {
          const muted = window.AudioManager.toggleMasterMute();
          alert(muted ? "üîá Master audio MUTED" : "üîä Master audio UNMUTED");
          showAudioSettings();
        } else if (choice === "5") {
          const muted = window.AudioManager.toggleBGMMute();
          alert(muted ? "üîá BGM MUTED" : "üîä BGM UNMUTED");
          showAudioSettings();
        } else if (choice === "6") {
          const muted = window.AudioManager.toggleSFXMute();
          alert(muted ? "üîá SFX MUTED" : "üîä SFX UNMUTED");
          showAudioSettings();
        } else if (choice === "7") {
          if (confirm("Reset all audio settings to defaults?")) {
            window.AudioManager.reset();
            alert("‚úÖ Audio settings reset to defaults");
          }
          showAudioSettings();
        } else if (choice === "8") {
          showSettingsMenu();
        }
      }

      console.log("‚úÖ All event listeners attached!");
    });
  </script>
</body>
</html>
