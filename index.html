<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blazing ‚Äî Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <!-- 16:9 Game Canvas Architecture -->
  <link rel="stylesheet" href="css/game-canvas.css" />
  <!-- Game UI Styles -->
  <link rel="stylesheet" href="css/background.css?v=2" />
  <link rel="stylesheet" href="css/top-bar.css?v=2" />
  <link rel="stylesheet" href="css/character-vignette.css?v=2" />
  <link rel="stylesheet" href="css/dashboard.css?v=2" />
  <link rel="stylesheet" href="css/summon-banner-carousel.css?v=2" />
  <link rel="stylesheet" href="css/ui-layout.css?v=2" />
  <link rel="stylesheet" href="css/settings-modal.css?v=2" />
  <link rel="stylesheet" href="css/modal-system.css?v=1" />
  <link rel="stylesheet" href="css/login-overlay.css" />
  <link rel="stylesheet" href="css/loading-bridge.css" />
  <!-- Hide scrollbar but keep functionality -->
  <style>
    body,
    html {
      margin: 0;
      min-height: 100vh;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(180deg, #0f131d, #0a0d15 45%, #080b12);
      color: #e9edf5;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <!-- Loading bridge shown after login -->
  <div id="login-loading" class="loading-bridge is-hidden" role="status" aria-live="polite">
    <div class="loading-bridge__spinner" aria-hidden="true"></div>
    <div class="loading-bridge__text" data-loading-message>Preparing village HUD‚Ä¶</div>
  </div>

  <!-- Login Overlay (Blocks hub until authenticated) -->
  <div id="login-overlay" class="login-overlay" role="dialog" aria-modal="true" aria-labelledby="login-title" data-redirect="village.html">
    <div class="login-panel">
      <div class="login-hero">
        <div class="login-hero__glow"></div>
        <div class="login-hero__content">
          <p class="login-eyebrow">Village Access Gate</p>
          <h2 id="login-title" class="login-heading">Sign in to enter the plaza</h2>
          <p class="login-copy">Log in once to unlock the HUD. You will stay signed in when you return from other screens.</p>
          <div class="login-actions">
            <button type="button" class="login-primary" data-login-fast>Enter the Village</button>
            <p class="login-hint">Already signed in? Tap the button above to dismiss this screen immediately.</p>
          </div>
          <ul class="login-perks">
            <li>Sync ninja rank and currencies</li>
            <li>Keep your username visible on the HUD</li>
            <li>Skip this step next time on this device</li>
          </ul>
        </div>
      </div>

      <div class="login-form" data-login-form>
        <form>
          <label class="login-label" for="login-username">Username</label>
          <input id="login-username" data-login-username type="text" name="username" maxlength="20" placeholder="Enter your ninja name" autocomplete="username" required />

          <label class="login-label" for="login-password">Password</label>
          <input id="login-password" type="password" name="password" maxlength="32" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />

          <button type="submit" class="login-primary">Log In</button>
          <button type="button" class="login-secondary" data-login-guest>Continue as guest</button>

          <p class="login-note">Your session is remembered locally so returning to the Village HUD won‚Äôt prompt you again.</p>
        </form>
      </div>
    </div>
  </div>

  <!-- 16:9 Game Canvas Wrapper (background + effects) -->
  <div class="game-canvas-wrapper">
    <div class="game-canvas">
      <div class="game-content">
        <div id="full-bg" class="bg-1"></div>
        <div class="character-vignette-container"></div>
        <div class="vignette-overlay"></div>
        <div class="wind-container"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/login-overlay.js"></script>
  <!-- Core Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

  <!-- Manager Scripts -->
  <script src="js/storage-manager.js"></script>
  <script src="js/touch-manager.js"></script>

  <!-- Game Scripts -->
  <script src="js/modal-manager.js?v=1"></script>
  <script src="js/user-profile.js?v=2"></script>
  <script src="js/music-player.js?v=2"></script>
  <script src="js/character_inv.js?v=2"></script>
  <script src="js/resources.js?v=2"></script>
  <script src="js/daily-missions.js?v=2"></script>
  <script src="js/top-bar.js?v=2"></script>
  <script src="js/character-vignette.js?v=2"></script>
  <script src="js/settings-modal.js?v=2"></script>
  <script src="js/announcement-slideshow.js?v=2"></script>
  <script src="js/dashboard-mailbox.js?v=2"></script>
  <script src="js/panel-missions.js"></script>
  <script src="js/index-banner-carousel.js?v=1"></script>
  <script src="js/navigation.js?v=2"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("‚úÖ JavaScript loaded!");

      // Initialize username display
      const usernameDisplay = document.getElementById("username-display");
      if (usernameDisplay && typeof window.UserProfile !== "undefined") {
        const username = window.UserProfile.getUsername();
        usernameDisplay.textContent = username;
        console.log(`üë§ Username loaded: ${username}`);

        // Listen for username changes
        window.addEventListener("usernameChanged", (e) => {
          usernameDisplay.textContent = e.detail.username;
          console.log(`üë§ Username updated: ${e.detail.username}`);
        });
      }

      // Initialize Dashboard Systems
      console.log("üéÆ Initializing Dashboard Systems...");

      // Initialize Calendar and Daily Streak
      if (window.DashboardCalendar) {
        window.DashboardCalendar.init();
        await updateDailyLoginDisplay();
      }

      // Initialize Mailbox
      if (window.DashboardMailbox) {
        window.DashboardMailbox.init();
        updateMailboxBadge();
      }

      // Initialize Stats
      if (window.DashboardStats) {
        await window.DashboardStats.init();
        updateCollectionStats();
      }

      // Initialize Announcements
      if (window.DashboardAnnouncements) {
        await window.DashboardAnnouncements.init('announcement-banner-container');
      }

      // Initialize Banner Slideshow
      if (window.DashboardBannerSlideshow) {
        await window.DashboardBannerSlideshow.init('dashboard-banner-slideshow');
      }

      // Initialize Announcement Slideshow (Top Right)
      if (window.AnnouncementSlideshow) {
        await window.AnnouncementSlideshow.init();
      }

      // Initialize Panel Missions
      if (window.PanelMissions) {
        await window.PanelMissions.init();
      }

      // Update Ninja Rank Progress Bar
      updateRankProgressBar();

      // Process login bonus
      if (typeof window.DailyMissions !== "undefined") {
        const loginResult = await window.DailyMissions.processLogin();
        if (loginResult.ok && !loginResult.alreadyClaimed) {
          const rewardText = Object.entries(loginResult.reward)
            .map(([mat, amt]) => `${mat}: ${amt}`)
            .join(", ");
          if (window.ModalManager) { window.ModalManager.showInfo(`Login Bonus Day ${loginResult.loginDay}!\n\nRewards:\n${rewardText}`); }
        }
      }

      // ===== HELPER FUNCTIONS =====

      async function updateDailyLoginDisplay() {
        if (!window.DashboardCalendar) return;
        const streak = window.DashboardCalendar.getStreak();
        const dayElement = document.getElementById('daily-login-day');
        const indicator = document.getElementById('daily-login-indicator');

        if (dayElement) {
          dayElement.textContent = `Day ${streak}/7`;
        }

        // Add notification dot if login bonus is available
        if (window.DailyMissions) {
          const loginStatus = await window.DailyMissions.getLoginStatus();
          if (loginStatus && !loginStatus.claimedToday) {
            indicator?.classList.add('has-reward');
          }
        }
      }

      function updateMailboxBadge() {
        if (!window.DashboardMailbox) return;
        const unreadCount = window.DashboardMailbox.getUnreadCount();
        const badge = document.getElementById('mailbox-badge');
        const presentNotification = document.getElementById('present-box-notification');

        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }

        // Show red orb on present box icon if there are any messages
        if (presentNotification) {
          if (unreadCount > 0) {
            presentNotification.style.display = 'block';
          } else {
            presentNotification.style.display = 'none';
          }
        }
      }

      function updateCollectionStats() {
        if (!window.DashboardStats) return;
        const percentage = window.DashboardStats.getCollectionPercentage();
        const valueElement = document.getElementById('collection-value');

        if (valueElement) {
          valueElement.textContent = percentage.toFixed(1) + '%';
        }
      }

      function updateRankProgressBar() {
        // Get current rank data from localStorage or default
        const rankData = JSON.parse(localStorage.getItem('ninjaRank') || '{"level": 1, "xp": 0, "xpToNext": 100}');

        const percentage = Math.min(100, (rankData.xp / rankData.xpToNext) * 100);
        const fillElement = document.getElementById('rank-progress-bar-fill');
        const textElement = document.getElementById('rank-progress-text');

        if (fillElement) {
          fillElement.style.width = percentage + '%';
        }

        if (textElement) {
          textElement.textContent = Math.floor(percentage) + '%';
        }
      }

      function navigateTo(url) {
        console.log(`üöÄ Navigating to: ${url}`);
        document.body.style.transition = "opacity 0.2s linear";
        document.body.style.opacity = "0";
        setTimeout(() => {
          window.location.href = url;
        }, 200);
      }

      // ===== BACKGROUND CYCLING SYSTEM =====

      const bgElement = document.getElementById("full-bg");
      const totalBackgrounds = 10;
      let currentBackground = 1;

      function updateBG(n) {
        if (!bgElement) return;
        for (let i = 1; i <= totalBackgrounds; i++) {
          bgElement.classList.remove(`bg-${i}`);
        }
        bgElement.classList.add(`bg-${n}`);
        console.log(`üé® Background changed to bg-${n}`);
      }

      // ===== RIGHT BANNER PANEL NAVIGATION =====
      const bannerButtons = document.querySelectorAll('.right-banner-panel .banner-button');
      bannerButtons.forEach(button => {
        button.addEventListener('click', () => {
          const action = button.classList[1]; // missions, characters, summon, fusion, shop
          console.log(`üéØ Banner clicked: ${action}`);

          switch(action) {
            case 'missions':
              navigateTo('missions.html');
              break;
            case 'characters':
              navigateTo('characters.html');
              break;
            case 'summon':
              navigateTo('summon.html');
              break;
            case 'fusion':
              navigateTo('fusion.html');
              break;
            case 'shop':
              navigateTo('shop.html');
              break;
          }
        });
      });

      // ===== BOTTOM ICON BAR NAVIGATION =====

      const bottomIcons = document.querySelectorAll('.bottom-icon');
      bottomIcons.forEach(icon => {
        icon.addEventListener('click', () => {
          const action = icon.dataset.action;
          console.log(`üî∑ Bottom icon clicked: ${action}`);

          switch(action) {
            case 'notice':
              if (window.ModalManager) { window.ModalManager.showInfo('üì¢ Notice Board\n\nNo new notices at this time.'); }
              break;
            case 'presents':
              if (window.DashboardMailbox) {
                window.DashboardMailbox.openMailbox();
              } else {
                if (window.ModalManager) { window.ModalManager.showInfo('üéÅ Present Box\n\nPresent box system not loaded. Please reload the page.'); }
              }
              break;
            case 'achievements':
              if (window.ModalManager) { window.ModalManager.showInfo('üèÜ Achievements\n\nAchievement system coming soon!'); }
              break;
            case 'panel-missions':
              if (window.PanelMissions) {
                window.PanelMissions.openPanelModal();
              } else {
                if (window.ModalManager) { window.ModalManager.showInfo('üìã Panel Missions\n\nPanel missions system not loaded. Please reload the page.'); }
              }
              break;
            case 'chat':
              if (window.ModalManager) { window.ModalManager.showInfo('üí¨ Chat\n\nChat system coming soon!'); }
              break;
            case 'inventory':
              navigateTo('inventory.html');
              break;
            case 'teams':
              navigateTo('teams.html');
              break;
            case 'resources':
              navigateTo('resources.html');
              break;
            case 'guilds':
              if (window.ModalManager) { window.ModalManager.showInfo('‚öîÔ∏è Guilds\n\nGuild system coming soon!'); }
              break;
            case 'settings':
              showSettingsMenu();
              break;
          }
        });
      });

      // ===== SETTINGS MENU SYSTEM =====

      function showSettingsMenu() {
        const choice = prompt(
          "‚öôÔ∏è SETTINGS MENU\n\n" +
          "1. Change Username\n" +
          "2. Change Background (1-10)\n" +
          "3. Audio Settings\n" +
          "4. Select Character Display\n" +
          "5. View Resources\n" +
          "6. Cancel\n\n" +
          "Enter your choice:"
        );

        if (choice === "1") {
          const currentUsername = window.UserProfile.getUsername();
          const newUsername = prompt(`Current username: ${currentUsername}\n\nEnter new username (max 20 characters):`);

          if (newUsername && newUsername.trim()) {
            const success = window.UserProfile.setUsername(newUsername);
            if (success) {
              if (window.ModalManager) { window.ModalManager.showInfo(`‚úÖ Username changed to: ${newUsername.trim()}`); }
            } else {
              if (window.ModalManager) { window.ModalManager.showInfo("‚ùå Failed to change username. Please use 1-20 characters."); }
            }
          }
        } else if (choice === "2") {
          const bgNum = prompt("Enter background number (1-10):");
          const num = parseInt(bgNum);
          if (num >= 1 && num <= 10) {
            currentBackground = num;
            updateBG(currentBackground);
            if (window.ModalManager) { window.ModalManager.showInfo(`‚úÖ Background changed to #${num}`); }
          } else {
            if (window.ModalManager) { window.ModalManager.showInfo("‚ùå Invalid background number. Please enter 1-10."); }
          }
        } else if (choice === "3") {
          showAudioSettings();
        } else if (choice === "4") {
          if (typeof window.CharacterVignette !== "undefined") {
            window.CharacterVignette.openCharacterSelector();
          } else {
            if (window.ModalManager) { window.ModalManager.showInfo("Character Vignette system not loaded yet. Please reload the page."); }
          }
        } else if (choice === "5") {
          navigateTo("resources.html");
        }
      }

      // ===== AUDIO SETTINGS SUBMENU =====

      function showAudioSettings() {
        if (typeof window.AudioManager === "undefined") {
          if (window.ModalManager) { window.ModalManager.showInfo("‚ö†Ô∏è Audio Manager not loaded. Please reload the page."); }
          return;
        }

        const masterVol = window.AudioManager.getVolumePercent("master");
        const bgmVol = window.AudioManager.getVolumePercent("bgm");
        const sfxVol = window.AudioManager.getVolumePercent("sfx");
        const settings = window.AudioManager.getSettings();

        const choice = prompt(
          "üîä AUDIO SETTINGS\n\n" +
          `Master Volume: ${masterVol}% ${settings.masterMuted ? "(MUTED)" : ""}\n` +
          `BGM Volume: ${bgmVol}% ${settings.bgmMuted ? "(MUTED)" : ""}\n` +
          `SFX Volume: ${sfxVol}% ${settings.sfxMuted ? "(MUTED)" : ""}\n\n` +
          "1. Set Master Volume (0-100)\n" +
          "2. Set BGM Volume (0-100)\n" +
          "3. Set SFX Volume (0-100)\n" +
          "4. Toggle Master Mute\n" +
          "5. Toggle BGM Mute\n" +
          "6. Toggle SFX Mute\n" +
          "7. Reset to Defaults\n" +
          "8. Back to Settings\n\n" +
          "Enter your choice:"
        );

        if (choice === "1") {
          const vol = prompt("Enter Master Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setMasterVolume(num / 100);
            if (window.ModalManager) { window.ModalManager.showInfo(`‚úÖ Master volume set to ${num}%`); }
          } else {
            if (window.ModalManager) { window.ModalManager.showInfo("‚ùå Invalid volume. Please enter 0-100."); }
          }
          showAudioSettings();
        } else if (choice === "2") {
          const vol = prompt("Enter BGM Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setBGMVolume(num / 100);
            if (window.ModalManager) { window.ModalManager.showInfo(`‚úÖ BGM volume set to ${num}%`); }
          } else {
            if (window.ModalManager) { window.ModalManager.showInfo("‚ùå Invalid volume. Please enter 0-100."); }
          }
          showAudioSettings();
        } else if (choice === "3") {
          const vol = prompt("Enter SFX Volume (0-100):");
          const num = parseInt(vol);
          if (!isNaN(num) && num >= 0 && num <= 100) {
            window.AudioManager.setSFXVolume(num / 100);
            if (window.ModalManager) { window.ModalManager.showInfo(`‚úÖ SFX volume set to ${num}%`); }
          } else {
            if (window.ModalManager) { window.ModalManager.showInfo("‚ùå Invalid volume. Please enter 0-100."); }
          }
          showAudioSettings();
        } else if (choice === "4") {
          const muted = window.AudioManager.toggleMasterMute();
          alert(muted ? "üîá Master audio MUTED" : "üîä Master audio UNMUTED");
          showAudioSettings();
        } else if (choice === "5") {
          const muted = window.AudioManager.toggleBGMMute();
          alert(muted ? "üîá BGM MUTED" : "üîä BGM UNMUTED");
          showAudioSettings();
        } else if (choice === "6") {
          const muted = window.AudioManager.toggleSFXMute();
          alert(muted ? "üîá SFX MUTED" : "üîä SFX UNMUTED");
          showAudioSettings();
        } else if (choice === "7") {
          if (window.ModalManager) {
            window.ModalManager.showConfirm("Reset all audio settings to defaults?", () => {
              window.AudioManager.reset();
              if (window.ModalManager) { window.ModalManager.showInfo("‚úÖ Audio settings reset to defaults"); }
            });
          }
          showAudioSettings();
        } else if (choice === "8") {
          showSettingsMenu();
        }
      }

      // ===== MUSIC INITIALIZATION =====
      // Start background music using AudioManager
      if (typeof window.AudioManager !== 'undefined') {
        console.log('üéµ Starting background music...');

        // Try to play after user interaction
        const startMusic = () => {
          const bgm = window.AudioManager.playBGM('assets/music/general.mp3');
          if (bgm) {
            console.log('üéµ Background music started successfully');
          } else {
            console.log('‚ö†Ô∏è Background music failed to start');
          }
        };

        // Add one-time click listener to start music
        document.addEventListener('click', () => {
          if (!window.AudioManager.currentBGM) {
            startMusic();
          }
        }, { once: true });

        // Also try immediately (may be blocked by browser autoplay policy)
        setTimeout(() => {
          if (!window.AudioManager.currentBGM) {
            startMusic();
          }
        }, 1000);
      } else {
        console.error('‚ùå AudioManager not found - music cannot play');
      }

      console.log("‚úÖ All systems initialized!");
    });
  </script>
</body>
</html>
